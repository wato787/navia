import type { Location } from "@/types/location";
import { BACKEND_API_URL } from "@/pages/const";

/**
 * ???????????????
 * ?????????????????????????
 */

/**
 * ???????????????
 */
export interface AutocompleteSuggestion {
  placeId: string;
  description: string;
  structuredFormatting: {
    mainText: string;
    secondaryText: string;
  };
  types: string[];
  location?: {
    latitude: number;
    longitude: number;
  };
}

/**
 * ???????????????
 */
export interface AutocompleteParams {
  query: string;
  proximity?: Location;
  limit?: number;
}

/**
 * ??????API???????
 */
interface AutocompleteResponse {
  data: AutocompleteSuggestion[];
}

/**
 * ???????????????
 */
export const AutocompleteUsecase = {
  /**
   * ??????????????
   * @param params ??????????????
   * @returns ??????
   * @throws ???????????????????
   */
  async fetchSuggestions(
    params: AutocompleteParams,
  ): Promise<AutocompleteSuggestion[]> {
    const { query, proximity, limit = 5 } = params;

    const queryParams = new URLSearchParams({
      input: query,
      limit: String(limit),
    });

    // proximity ??????????????????????
    if (proximity) {
      queryParams.append("latitude", String(proximity.lat));
      queryParams.append("longitude", String(proximity.lng));
    }

    const response = await fetch(
      `${BACKEND_API_URL}/api/places/autocomplete?${queryParams.toString()}`,
    );

    if (!response.ok) {
      const error = await response.json();
      console.error("Autocomplete API error:", error);
      throw new Error(
        `???????????????????: ${response.statusText}`,
      );
    }

    const result: AutocompleteResponse = await response.json();

    if (!Array.isArray(result.data)) {
      throw new Error("??????????");
    }

    return result.data;
  },
};
