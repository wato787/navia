# ?????????????

## ??????
- **?????**: Bun v1.x
- **???????**: Hono v4 (???????????)
- **???????**: Zod v3 + @hono/zod-validator
- **???????**: JSON ??

## ????????

```
src/
??? app/
?   ??? index.ts              # Hono ???????????????????
??? config/
?   ??? env.ts                # ???????????
??? lib/
?   ??? logger.ts             # ????????????
??? middleware/
?   ??? requestLogger.ts      # ?????????????
??? modules/                  # ???????
?   ??? health/
?       ??? index.ts          # ????????????
?       ??? routes.ts         # ?????
??? routes/
?   ??? index.ts              # ?????
??? types/
?   ??? app.ts                # ???????????
??? utils/
?   ??? response.ts           # ?????????
??? plugins/
?   ??? validator.ts          # ???????????
??? index.ts                  # ????????
```

## ???????????????????

### `src/index.ts`
Bun ? `serve` API ????????????

```typescript
import { serve } from "bun";
import { createApp } from "./app";
import { ENV } from "./config/env";

const app = createApp();

serve({
  port: ENV.PORT,
  fetch: app.fetch,
});
```

### `src/app/index.ts`
Hono ??????????????????????????

```typescript
import { Hono } from "hono";
import { cors } from "hono/cors";
import { prettyJSON } from "hono/pretty-json";
import { requestId } from "hono/request-id";
import { trimTrailingSlash } from "hono/trailing-slash";

export const createApp = () => {
  const app = new Hono<AppBindings>();

  // ???????????
  app.use("*", trimTrailingSlash());
  app.use("*", requestId());
  app.use("*", cors({ /* ... */ }));
  app.use("*", requestLogger());

  // ?????
  registerRoutes(app);

  // ?????????
  app.notFound((c) => c.json({ error: { message: "Resource not found" } }, 404));
  app.onError((err, c) => { /* ... */ });

  return app;
};
```

**???????????:**
1. `trimTrailingSlash()` - URL???????????
2. `requestId()` - ?????ID??????
3. `cors()` - CORS ???????
4. `prettyJSON()` - ????JSON???????????
5. `requestLogger()` - ???????????

## ??????

`src/config/env.ts` ? Zod ???????????????

```typescript
import { z } from "zod";

const EnvSchema = z.object({
  NODE_ENV: z.enum(["development", "test", "production"]).default("development"),
  PORT: z.coerce.number().int().positive().default(8787),
  BASE_URL: z.string().url().optional(),
  LOG_LEVEL: z.enum(["debug", "info", "warn", "error"]).default("info"),
});

const parsedEnv = EnvSchema.safeParse({
  NODE_ENV: Bun.env.NODE_ENV,
  PORT: Bun.env.PORT,
  BASE_URL: Bun.env.BASE_URL,
  LOG_LEVEL: Bun.env.LOG_LEVEL,
});

if (!parsedEnv.success) {
  console.error("Failed to validate environment variables", parsedEnv.error.flatten().fieldErrors);
  throw new Error("Invalid environment variables");
}

export const ENV = parsedEnv.data;
export const isProduction = ENV.NODE_ENV === "production";
```

?????????????????????????????? `ENV` ?????????????

## ?????????Hono ??????????

### ????
- **????? `app.route()` ???** - ??????????
- **??????? Hono ??????? export** - ??????
- **????????????** - `src/routes/index.ts` ???

### ???????

???? `src/modules/<feature>/` ?????????

```
src/modules/
??? health/
    ??? index.ts       # ?????????????
    ??? routes.ts      # ??????Hono ???????
```

#### `src/modules/health/routes.ts`
```typescript
import { Hono } from "hono";
import type { AppBindings } from "../../types/app";
import { ok } from "../../utils/response";

const health = new Hono<AppBindings>();

health.get("/live", (c) =>
  ok(c, {
    status: "ok",
    uptime: process.uptime(),
    timestamp: new Date().toISOString(),
  }),
);

health.get("/ready", (c) =>
  ok(c, {
    status: "ready",
  }),
);

export default health;
```

#### `src/modules/health/index.ts`
```typescript
export { default } from "./routes";
```

### ?????

`src/routes/index.ts` ??????????????

```typescript
import { Hono } from "hono";
import { ENV } from "../config/env";
import health from "../modules/health";
import type { AppBindings } from "../types/app";
import { ok } from "../utils/response";

export const registerRoutes = (app: Hono<AppBindings>) => {
  // ??????????
  app.get("/", (c) =>
    ok(c, {
      name: "@bun-mise/backend",
      status: "ok",
      environment: ENV.NODE_ENV,
      timestamp: new Date().toISOString(),
    }),
  );

  // ??????
  app.get("/healthz", (c) => c.redirect("/api/health/live"));

  // API ???
  const api = new Hono<AppBindings>();
  api.route("/health", health);
  // ??????????????
  // api.route("/users", users);
  // api.route("/posts", posts);

  app.route("/api", api);
};
```

????????????????????????
1. `src/modules/<feature>/routes.ts` ???
2. `src/routes/index.ts` ?????????

?????????

## ?????????

`src/utils/response.ts` ????????????????????

```typescript
import type { Context } from "hono";
import type { AppBindings } from "../types/app";

export const ok = <TData, TMeta = undefined>(
  c: Context<AppBindings>,
  data: TData,
  meta?: TMeta,
) => {
  const body = meta === undefined ? { data } : { data, meta };
  return c.json(body, 200);
};

export const created = <TData>(c: Context<AppBindings>, data: TData) =>
  c.json({ data }, 201);

export const accepted = <TData>(c: Context<AppBindings>, data: TData) =>
  c.json({ data }, 202);

export const noContent = (c: Context<AppBindings>) => c.body(null, 204);
```

**???:**
```typescript
// ??????????
return ok(c, { id: 1, name: "John" });
// => { "data": { "id": 1, "name": "John" } }

// ??????????
return ok(c, users, { page: 1, total: 100 });
// => { "data": [...], "meta": { "page": 1, "total": 100 } }
```

## ???????

`src/plugins/validator.ts` ? Zod ??????????????????????

```typescript
import { zValidator } from "@hono/zod-validator";
import type { z } from "zod";

export const validateJson = <T extends z.ZodType>(schema: T) =>
  zValidator("json", schema);

export const validateQuery = <T extends z.ZodType>(schema: T) =>
  zValidator("query", schema);

export const validateParams = <T extends z.ZodType>(schema: T) =>
  zValidator("param", schema);
```

**???:**
```typescript
import { z } from "zod";
import { validateJson } from "../../plugins/validator";

const CreateUserSchema = z.object({
  name: z.string().min(1),
  email: z.string().email(),
  age: z.number().int().positive().optional(),
});

users.post("/", validateJson(CreateUserSchema), async (c) => {
  const body = c.req.valid("json"); // ???
  // body.name, body.email ?????
  return created(c, { id: 1, ...body });
});
```

## ????

### ????? (`src/lib/logger.ts`)
```typescript
type LogLevel = "debug" | "info" | "warn" | "error";

const logLevels: Record<LogLevel, number> = {
  debug: 0,
  info: 1,
  warn: 2,
  error: 3,
};

const log = (level: LogLevel, message: string, data?: Record<string, unknown>) => {
  if (logLevels[level] < logLevels[ENV.LOG_LEVEL]) return;

  console.log(
    JSON.stringify({
      level,
      message,
      timestamp: new Date().toISOString(),
      ...data,
    }),
  );
};

export const logger = {
  debug: (msg: string, data?: Record<string, unknown>) => log("debug", msg, data),
  info: (msg: string, data?: Record<string, unknown>) => log("info", msg, data),
  warn: (msg: string, data?: Record<string, unknown>) => log("warn", msg, data),
  error: (msg: string, data?: Record<string, unknown>) => log("error", msg, data),
};
```

### ????????????? (`src/middleware/requestLogger.ts`)
```typescript
export const requestLogger = (): MiddlewareHandler<AppBindings> => {
  return async (c, next) => {
    const start = performance.now();

    try {
      await next();
    } finally {
      const durationMs = Math.round((performance.now() - start) * 100) / 100;
      const status = c.res?.status ?? 500;
      const logLevel = status >= 500 ? "error" : status >= 400 ? "warn" : "info";

      logger[logLevel]("request.completed", {
        requestId: c.get("requestId"),
        method: c.req.method,
        path: c.req.path,
        status,
        durationMs,
      });
    }
  };
};
```

**?????:**
```json
{"level":"info","message":"request.completed","timestamp":"2025-11-02T10:30:45.123Z","requestId":"abc123","method":"GET","path":"/api/health/live","status":200,"durationMs":2.45}
```

## ?????????????

### 1. ??????????????
```bash
mkdir -p src/modules/users
```

### 2. ???????? (`src/modules/users/routes.ts`)
```typescript
import { Hono } from "hono";
import { z } from "zod";
import type { AppBindings } from "../../types/app";
import { validateJson, validateParams } from "../../plugins/validator";
import { created, ok } from "../../utils/response";

const users = new Hono<AppBindings>();

// ??????
const CreateUserSchema = z.object({
  name: z.string().min(1),
  email: z.string().email(),
});

const UpdateUserSchema = CreateUserSchema.partial();

const ParamsSchema = z.object({
  id: z.string().uuid(),
});

// ?????
users.get("/", (c) => {
  // ????????
  return ok(c, [
    { id: "1", name: "Alice", email: "alice@example.com" },
    { id: "2", name: "Bob", email: "bob@example.com" },
  ]);
});

users.get("/:id", validateParams(ParamsSchema), (c) => {
  const { id } = c.req.valid("param");
  // ??????
  return ok(c, { id, name: "Alice", email: "alice@example.com" });
});

users.post("/", validateJson(CreateUserSchema), (c) => {
  const body = c.req.valid("json");
  // ??????
  return created(c, { id: "3", ...body });
});

users.patch("/:id", validateParams(ParamsSchema), validateJson(UpdateUserSchema), (c) => {
  const { id } = c.req.valid("param");
  const body = c.req.valid("json");
  // ??????
  return ok(c, { id, ...body });
});

users.delete("/:id", validateParams(ParamsSchema), (c) => {
  const { id } = c.req.valid("param");
  // ??????
  return c.body(null, 204);
});

export default users;
```

### 3. ????????????? (`src/modules/users/index.ts`)
```typescript
export { default } from "./routes";
```

### 4. ?????? (`src/routes/index.ts`)
```typescript
import users from "../modules/users";

export const registerRoutes = (app: Hono<AppBindings>) => {
  // ...

  const api = new Hono<AppBindings>();
  api.route("/health", health);
  api.route("/users", users); // ? ??

  app.route("/api", api);
};
```

??? `/api/users` ???????API ???????????

## ?????????????

### ?: ???????? (`src/middleware/auth.ts`)
```typescript
import { createMiddleware } from "hono/factory";
import type { AppBindings } from "../types/app";

export const auth = () =>
  createMiddleware<AppBindings>(async (c, next) => {
    const token = c.req.header("Authorization")?.replace("Bearer ", "");

    if (!token) {
      return c.json({ error: { message: "Unauthorized" } }, 401);
    }

    // ??????????
    // const user = await verifyToken(token);
    // c.set("user", user);

    await next();
  });
```

### ?????????

**?????????:**
```typescript
import { auth } from "../../middleware/auth";

users.get("/profile", auth(), (c) => {
  // c.get("user") ??????????????
  return ok(c, { profile: "..." });
});
```

**??????????:**
```typescript
const users = new Hono<AppBindings>();
users.use("*", auth()); // ????????????????
```

**????????:**
```typescript
// src/app/index.ts
app.use("/api/*", auth()); // ????API????????????
```

## ?????????

Hono ??????????????? `src/app/index.ts` ??????????

```typescript
app.onError((err, c) => {
  logger.error("error", {
    error: err,
    requestId: c.get("requestId"),
  });
  return c.json(
    {
      error: {
        message: "Internal server error",
      },
    },
    500,
  );
});
```

???????????????Hono ? `HTTPException` ???????

```typescript
import { HTTPException } from "hono/http-exception";

users.get("/:id", async (c) => {
  const user = await findUser(c.req.param("id"));
  
  if (!user) {
    throw new HTTPException(404, { message: "User not found" });
  }

  return ok(c, user);
});
```

## ??

```bash
# ?????????????
bun install

# ???????????????????
bun run --watch src/index.ts

# ??????????
bun run build
```

## ????????

| ???? | ?? | ?? |
|---------|------|------|
| `GET` | `/` | API ?? |
| `GET` | `/healthz` | `/api/health/live` ??????? |
| `GET` | `/api/health/live` | ????????liveness? |
| `GET` | `/api/health/ready` | ????????readiness? |

**??????:**
```json
// GET /api/health/live
{
  "data": {
    "status": "ok",
    "uptime": 123.456,
    "timestamp": "2025-11-02T10:30:45.123Z"
  }
}
```

## ?????????

### ? DO
- ??????????? Hono ?????????
- ???????????????????????
- ????????? (`ok`, `created` ??) ???
- ???? `HTTPException` ????
- ?????? `requestId` ????

### ? DON'T
- ?????????????
- ???????????????????
- ??????????????????????
- ??????????????????

## ????

- [Hono ????????](https://hono.dev/)
- [Hono ?????????](https://hono.dev/docs/guides/best-practices)
- [Zod ??????](https://zod.dev/)
- [Bun ??????](https://bun.sh/docs)
